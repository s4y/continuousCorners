<!DOCTYPE html>
<p><label>Radius<br><input id=radiusInput type=range min=0 max=1 value=0.5 step=0.001></label></p>
<p><label>Smoothness<br><input id=smoothnessInput type=range min=0.7 max=4 value=1 step=0.001></label></p>
<p><svg width=200 height=200 viewBox="-1 -1 2 2">
  <rect id=roundrect fill=red rx=0.5 ry=0.5 x=-1 y=-1 width=2 height=2></rect>
  <path id=squircle x=1 fill="rgba(255, 0, 0, 1)" style="
    mix-blend-mode: difference;
  " />
</svg></p>

<script>

const roundrectEl = document.getElementById('roundrect');
const pathEl = document.getElementById('squircle');

const rotate = ([x, y], θ) => {
  return [
    x * Math.cos(θ) + y * Math.sin(θ),
    -x * Math.sin(θ) + y * Math.cos(θ),
  ];
};

const updateSquircle = () => {
  const radius = radiusInput.valueAsNumber;
  const smoothness = smoothnessInput.valueAsNumber;
  const midpointInset = radius - Math.sin(Math.PI * 0.25) * radius;
  const endInset = Math.min(1, midpointInset * 4 * smoothness);
  const velocity = Math.sqrt(
    Math.pow(midpointInset, 2) +
    Math.pow(endInset + midpointInset, 2)
  ) / 4 / smoothness;
  console.log(endInset);
  const side = [
    [-1, 0-endInset-velocity],
    [-1, -1+endInset+velocity],
    [-1, -1+endInset],
  ];
  const cornerA = [
    [
      -1 + midpointInset + Math.cos(Math.PI * 1.25) * velocity,
      -1 + midpointInset + Math.sin(Math.PI * 1.25) * -velocity
    ],
    [-1 + midpointInset, -1 + midpointInset],
  ];
  const cornerB = [
    [-1 + endInset - velocity, -1],
    [-1 + endInset, -1],
  ];

  const rotatePoints = (points, rotation) =>
    points.map(p => rotate(p, Math.PI * rotation))
  ;

  const joinPoints = points =>
    points.map(coord => coord.join(' ')).join(' ')
  ;

  const buildCorner = rotation => `
    C ${joinPoints(rotatePoints(side, rotation))},
    S ${joinPoints(rotatePoints(cornerA, rotation))},
    S ${joinPoints(rotatePoints(cornerB, rotation))}
  `;

  roundrectEl.setAttribute('rx', radius);
  roundrectEl.setAttribute('ry', radius);
  pathEl.setAttribute('d', `
    M -1 ${4-endInset},
    ${[0, -0.5, -1, -1.5].map(r => buildCorner(r)).join(',')},
  Z`);
}

radiusInput.addEventListener('input', updateSquircle);
smoothnessInput.addEventListener('input', updateSquircle);
updateSquircle();

</script>
